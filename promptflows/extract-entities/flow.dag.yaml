$schema: https://azuremlschemas.azureedge.net/promptflow/latest/Flow.schema.json
environment:
  python_requirements_txt: requirements.txt
inputs:
  sql:
    type: string
    default: >-
      CREATE PROCEDURE sp_PerformOperations

      AS

      BEGIN
          -- Declare variables
          DECLARE @PersonID INT,
                  @OrderID INT,
                  @ProductID INT,
                  @OrderQty SMALLINT,
                  @UnitPrice MONEY,
                  @UnitPriceDiscount MONEY,
                  @LineTotal MONEY,
                  @ModifiedDate DATETIME;

          SET @PersonID = 1;
          SET @OrderID = 1;
          SET @ProductID = 1;
          SET @OrderQty = 1;
          SET @UnitPrice = 100.00;
          SET @UnitPriceDiscount = 0.00;
          SET @LineTotal = @OrderQty * @UnitPrice;
          SET @ModifiedDate = GETDATE();

          -- Query from Person table
          SELECT FirstName, LastName
          FROM Person.Person
          WHERE BusinessEntityID = @PersonID;

          -- Update Person table
          UPDATE Person.Person
          SET EmailPromotion = 1
          WHERE BusinessEntityID = @PersonID;

          -- Insert into SalesOrderHeader table
          INSERT INTO Sales.SalesOrderHeader (CustomerID, OrderDate, DueDate, ShipDate, Status, OnlineOrderFlag, SalesOrderNumber, PurchaseOrderNumber, AccountNumber, CustomerID, ShipMethod, CreditCardApprovalCode, SubTotal, TaxAmt, Freight, TotalDue, Comment, rowguid, ModifiedDate)
          VALUES (@PersonID, @ModifiedDate, DATEADD(DAY, 7, @ModifiedDate), DATEADD(DAY, 7, @ModifiedDate), 1, 1, 'SO'+CAST(@OrderID AS VARCHAR), 'PO'+CAST(@OrderID AS VARCHAR), 'AC'+CAST(@OrderID AS VARCHAR), @PersonID, 'SHIP', 'CC', @LineTotal, @LineTotal * 0.05, @LineTotal * 0.01, @LineTotal * 1.06, 'Comment', NEWID(), @ModifiedDate);

          -- Query from SalesOrderHeader table
          SELECT SalesOrderID, OrderDate, DueDate, ShipDate
          FROM Sales.SalesOrderHeader
          WHERE SalesOrderID = @OrderID;

          -- Insert into SalesOrderDetail table
          INSERT INTO Sales.SalesOrderDetail (SalesOrderID, CarrierTrackingNumber, OrderQty, ProductID, SpecialOfferID, UnitPrice, UnitPriceDiscount, LineTotal, rowguid, ModifiedDate)
          VALUES (@OrderID, 'CT'+CAST(@OrderID AS VARCHAR), @OrderQty, @ProductID, 1, @UnitPrice, @UnitPriceDiscount, @LineTotal, NEWID(), @ModifiedDate);

          -- Query from SalesOrderDetail table
          SELECT SalesOrderID, OrderQty, ProductID, UnitPrice, UnitPriceDiscount, LineTotal
          FROM Sales.SalesOrderDetail
          WHERE SalesOrderID = @OrderID;

          -- Update SalesOrderDetail table
          UPDATE Sales.SalesOrderDetail
          SET OrderQty = OrderQty + 1
          WHERE SalesOrderID = @OrderID AND ProductID = @ProductID;
      END;

      GO
outputs:
  entities:
    type: string
    reference: ${echo_extracted_entities.output}
nodes:
- name: extract_entities
  type: llm
  source:
    type: code
    path: extract_entities.jinja2
  inputs:
    deployment_name: gpt-35-turbo-instruct
    max_tokens: 4000
    temperature: 0
    text: ${inputs.sql}
  connection: dsr-aisandbox-swc-aiservices752581255487_aoai
  api: completion
- name: echo_extracted_entities
  type: python
  source:
    type: code
    path: echo_extracted_entities.py
  inputs:
    entities: ${extract_entities.output}
